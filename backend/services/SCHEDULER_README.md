# Scheduler Service - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á (Cron Jobs) –¥–ª—è OZON Bot Backend.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω—ç–ø—à–æ—Ç–æ–≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π** - –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω** - –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**
4. **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á**

---

## üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫

Scheduler –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ [main.py](../main.py):

```python
@app.on_event("startup")
async def startup_event():
    # ...
    from services.scheduler import start_scheduler
    start_scheduler()
    # ...
```

–ò –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ shutdown:

```python
@app.on_event("shutdown")
async def shutdown_event():
    from services.scheduler import stop_scheduler
    stop_scheduler()
```

---

## ‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á

### 1. Update Comparison Snapshots

**–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:** –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 (–ø–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –≥—Ä—É–ø–ø—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏–∑ –ë–î
- –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã:
  - –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞—Ä—Ç–∏–∫—É–ª–æ–≤ (scraping —Å OZON)
  - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–Ω—ç–ø—à–æ—Ç –≤ `ozon_scraper_comparison_snapshots`
- –õ–æ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (—É—Å–ø–µ—à–Ω–æ/–æ—à–∏–±–∫–∏/–≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

**–ü–æ–ª—å–∑–∞:**
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- –ì—Ä–∞—Ñ–∏–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏

---

### 2. Update Price History

**–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:** –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 04:00 (–ø–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞—Ä—Ç–∏–∫—É–ª—ã –∏–∑ –ë–î
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞:
  - –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å OZON (scraping)
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω
- –õ–æ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

**–ü–æ–ª—å–∑–∞:**
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω
- –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–∏—Ö —Ü–µ–Ω –∑–∞ –ø–µ—Ä–∏–æ–¥
- –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è

---

## üß™ –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Python —Å–∫—Ä–∏–ø—Ç

```bash
# –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ backend/
python3 services/scheduler.py test-snapshots  # –¢–µ—Å—Ç —Å–Ω—ç–ø—à–æ—Ç–æ–≤
python3 services/scheduler.py test-price      # –¢–µ—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω
```

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ Python REPL

```python
import asyncio
from services.scheduler import update_comparison_snapshots, update_price_history

# –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–Ω—ç–ø—à–æ—Ç–æ–≤
asyncio.run(update_comparison_snapshots())

# –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω
asyncio.run(update_price_history())
```

### –°–ø–æ—Å–æ–± 3: Standalone —Ä–µ–∂–∏–º

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å scheduler –≤ standalone —Ä–µ–∂–∏–º–µ (–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ)
python3 services/scheduler.py
```

---

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ scheduler –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `loguru`:

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏:

```
============================================================
üîÑ Starting comparison snapshots update...
============================================================
Found 5 comparison groups to update
Processing group abc-123 (–ú–æ–π —Ç–æ–≤–∞—Ä vs –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç)
Updating 2 articles in group
  ‚úÖ Article xyz-1 updated
  ‚úÖ Article xyz-2 updated
‚úÖ Snapshot saved for group abc-123 (Index: 0.72, Grade: B)
============================================================
‚úÖ Comparison snapshots update completed!
   Total groups: 5
   Successful: 5
   Errors: 0
   Time elapsed: 45.3s
============================================================
```

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ:

```
‚ùå Error processing group abc-123: Timeout while scraping
‚ùå Critical error in update_comparison_snapshots: Database connection failed
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ [scheduler.py](scheduler.py):

```python
def start_scheduler():
    # –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ 02:00)
    scheduler.add_job(
        update_comparison_snapshots,
        trigger=CronTrigger(hour=2, minute=0),  # ‚Üê –ò–∑–º–µ–Ω–∏—Ç—å –∑–¥–µ—Å—å
        id='update_comparison_snapshots',
        name='Update Comparison Snapshots',
        replace_existing=True
    )
```

### –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π:

```python
# –ö–∞–∂–¥—ã–π —á–∞—Å
CronTrigger(minute=0)

# –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
CronTrigger(hour='*/6')

# –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 10:00
CronTrigger(day_of_week='mon', hour=10, minute=0)

# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 –∏ 15:00
CronTrigger(hour='3,15', minute=0)
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **Scraping –∑–∞–Ω–∏–º–∞–µ—Ç ~2-5 —Å–µ–∫—É–Ω–¥** –Ω–∞ –∞—Ä—Ç–∏–∫—É–ª
- –î–ª—è 100 –≥—Ä—É–ø–ø (200 –∞—Ä—Ç–∏–∫—É–ª–æ–≤) –∑–∞–¥–∞—á–∞ –∑–∞–π–º–µ—Ç **~7-15 –º–∏–Ω—É—Ç**
- –ú–µ–∂–¥—É scraping –∑–∞–ø—Ä–æ—Å–∞–º–∏ –µ—Å—Ç—å –ø–∞—É–∑–∞ `await asyncio.sleep(1-2)` –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ OZON

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ï—Å–ª–∏ scraping –æ–¥–Ω–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞ –Ω–µ —É–¥–∞–ª—Å—è - **–∑–∞–¥–∞—á–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É**
- –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –ø—Ä–æ—Ü–µ—Å—Å
- –í –∫–æ–Ω—Ü–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: —É—Å–ø–µ—à–Ω–æ/–æ—à–∏–±–∫–∏

### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–∞–±–ª–∏—Ü—ã:
  - `ozon_scraper_article_groups`
  - `ozon_scraper_article_group_members`
  - `ozon_scraper_articles`
  - `ozon_scraper_comparison_snapshots`

### 4. Timezone

- APScheduler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞**
- –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å timezone:

```python
from pytz import timezone

scheduler = AsyncIOScheduler(timezone=timezone('Europe/Moscow'))
```

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Scheduler –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ apscheduler
pip3 list | grep -i apscheduler

# –ï—Å–ª–∏ –Ω–µ—Ç - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
pip3 install apscheduler==3.10.4
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–¥–∞—á–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
from services.scheduler import scheduler

for job in scheduler.get_jobs():
    print(f"Job: {job.name}, Next run: {job.next_run_time}")
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –ø—Ä–∏ scraping

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å OZON
- –£–≤–µ–ª–∏—á–∏—Ç—å timeout –≤ `ozon_scraper.py`

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production:

1. **–õ–æ–≥–∏ –≤ —Ñ–∞–π–ª:**
   - –í—Å–µ –ª–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `loguru` –≤ `backend/logs/`
   - Retention: 7 –¥–Ω–µ–π
   - Rotation: 1 –¥–µ–Ω—å

2. **–ê–ª–µ—Ä—Ç—ã:**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

3. **–ú–µ—Ç—Ä–∏–∫–∏:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø/–∞—Ä—Ç–∏–∫—É–ª–æ–≤
   - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
   - –ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- [scheduler.py](scheduler.py) - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
- [main.py](../main.py) - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FastAPI
- [comparison_service.py](comparison_service.py) - —Å–µ—Ä–≤–∏—Å —Å—Ä–∞–≤–Ω–µ–Ω–∏–π
- [article_service.py](article_service.py) - —Å–µ—Ä–≤–∏—Å –∞—Ä—Ç–∏–∫—É–ª–æ–≤

---

## ‚úÖ Checklist –¥–ª—è production

- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `apscheduler==3.10.4`
- [ ] Scheduler –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ startup
- [ ] Scheduler –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ shutdown
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π timezone
- [ ] –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤ —Ñ–∞–π–ª
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-10-31
**–ê–≤—Ç–æ—Ä:** AI Agent
**–°—Ç–∞—Ç—É—Å:** Production Ready ‚úÖ
