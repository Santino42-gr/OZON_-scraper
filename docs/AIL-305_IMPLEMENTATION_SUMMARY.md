# üìù AIL-305: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ —Ü–µ–Ω–∞—Ö - –°–≤–æ–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**Task ID:** AIL-305  
**Title:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ —Ü–µ–Ω–∞—Ö: —Å—Ä–µ–¥–Ω—è—è –∑–∞ 7 –¥–Ω–µ–π + —Ü–µ–Ω—ã —Å/–±–µ–∑ Ozon Card  
**Status:** ‚úÖ **COMPLETED**  
**Date:** 2025-10-21  
**Priority:** High

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### ‚úÖ Phase 1: –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω —á–µ—Ä–µ–∑ Cron Job

#### 1.1 –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `docs/migrations/004_ozon_scraper_price_history.sql`

–°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω:

```sql
CREATE TABLE ozon_scraper_price_history (
    id UUID PRIMARY KEY,
    article_number VARCHAR(255) NOT NULL,
    price DECIMAL(10,2),
    normal_price DECIMAL(10,2),      -- –¶–µ–Ω–∞ –±–µ–∑ Ozon Card
    ozon_card_price DECIMAL(10,2),   -- –¶–µ–Ω–∞ —Å Ozon Card
    old_price DECIMAL(10,2),
    price_date TIMESTAMP NOT NULL,
    source VARCHAR(50),
    scraping_success BOOLEAN,
    product_available BOOLEAN,
    rating DECIMAL(3,2),
    reviews_count INTEGER
);
```

**SQL —Ñ—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ `get_average_price_7days(article_number, days)` - —Ä–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã
- ‚úÖ `get_price_history(article_number, days, limit)` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
- ‚úÖ `cleanup_old_price_history()` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### 1.2 Cron Job –¥–ª—è —Å–±–æ—Ä–∞ —Ü–µ–Ω

**–§–∞–π–ª:** `backend/cron_jobs/price_history_collector.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä —Ü–µ–Ω –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
- Batch processing —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
- Rate limiting –∏ –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å retry –ª–æ–≥–∏–∫–æ–π

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```bash
OZON_SCRAPER_BATCH_SIZE=10    # –ê—Ä—Ç–∏–∫—É–ª–æ–≤ –≤ –æ–¥–Ω–æ–º batch
OZON_SCRAPER_DELAY=5          # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (—Å–µ–∫)
```

**–ó–∞–ø—É—Å–∫:**
```bash
python -m cron_jobs.price_history_collector
```

---

### ‚úÖ Phase 2: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ OzonScraper

#### 2.1 –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ HTML

**–§–∞–π–ª:** `backend/services/ozon_scraper.py`

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

1. **`_parse_product_from_html()`** - –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ü–µ–Ω:
   - üí∞ –û–±—ã—á–Ω–∞—è —Ü–µ–Ω–∞ (–±–µ–∑ Ozon Card) - —Å–µ–ª–µ–∫—Ç–æ—Ä `[data-widget="webPrice"]`
   - üí≥ –¶–µ–Ω–∞ —Å Ozon Card - —Å–µ–ª–µ–∫—Ç–æ—Ä `[data-widget="webOzonCardPrice"]`
   - üè∑Ô∏è –°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (–ø–µ—Ä–µ—á–µ—Ä–∫–Ω—É—Ç–∞—è) - –ø–æ–∏—Å–∫ –ø–æ `line-through` –∏–ª–∏ `<s>`
   - ‚≠ê –†–µ–π—Ç–∏–Ω–≥ –∏ –æ—Ç–∑—ã–≤—ã
   - üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ URL —Ç–æ–≤–∞—Ä–∞
   - ‚úÖ –°—Ç–∞—Ç—É—Å –Ω–∞–ª–∏—á–∏—è

2. **`_parse_price_text()`** - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Ü–µ–Ω—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞:
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: "1 999 ‚ÇΩ", "1999", "1,999.00"
   - –û—á–∏—Å—Ç–∫–∞ –æ—Ç —Å–∏–º–≤–æ–ª–æ–≤ –≤–∞–ª—é—Ç—ã
   - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ float

3. **`get_product_prices_detailed()`** - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ü–µ–Ω —Å —Ä–∞—Å—á–µ—Ç–æ–º —Å—Ä–µ–¥–Ω–µ–π –∑–∞ 7 –¥–Ω–µ–π

#### 2.2 –£–ª—É—á—à–µ–Ω–∏—è –≤ scraping

- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ (fallback)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ü–µ–Ω
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ —Å –∫–∞—Ä—Ç–æ–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –∏–∑ –ë–î (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQL —Ñ—É–Ω–∫—Ü–∏–µ–π)

---

### ‚úÖ Phase 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –¥–∞–Ω–Ω—ã—Ö

#### 3.1 –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã articles

**–§–∞–π–ª:** `docs/migrations/006_add_detailed_prices_to_articles.sql`

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è:

```sql
ALTER TABLE ozon_scraper_articles
ADD COLUMN normal_price DECIMAL(10,2),
ADD COLUMN ozon_card_price DECIMAL(10,2),
ADD COLUMN average_price_7days DECIMAL(10,2),
ADD COLUMN price_updated_at TIMESTAMP;
```

**SQL —Ñ—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ `update_all_average_prices()` - –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–∏—Ö —Ü–µ–Ω
- ‚úÖ `update_article_average_price(article_number)` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞

#### 3.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Pydantic –º–æ–¥–µ–ª–µ–π

**–§–∞–π–ª:** `backend/models/article.py`

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏:**
- ‚úÖ `ArticleBase` - –¥–æ–±–∞–≤–ª–µ–Ω—ã `normal_price`, `ozon_card_price`, `average_price_7days`
- ‚úÖ `ArticleUpdate` - –¥–æ–±–∞–≤–ª–µ–Ω–æ `price_updated_at`
- ‚úÖ `ArticleResponse` - –¥–æ–±–∞–≤–ª–µ–Ω–æ `price_updated_at`

**–§–∞–π–ª:** `backend/models/ozon_models.py`

–£–∂–µ —Å–æ–¥–µ—Ä–∂–∞–ª –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥–µ–ª–∏:
- ‚úÖ `ProductInfo` - —Å –ø–æ–ª—è–º–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ü–µ–Ω
- ‚úÖ `ProductPriceDetailed` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω–∞—Ö
- ‚úÖ `PriceHistory` - –º–æ–¥–µ–ª—å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω
- ‚úÖ `PriceHistoryStats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–µ–Ω–∞–º

---

### ‚úÖ Phase 4: API Endpoints

#### 4.1 –ù–æ–≤—ã–π —Ä–æ—É—Ç–µ—Ä

**–§–∞–π–ª:** `backend/routers/prices.py`

–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ä–æ—É—Ç–µ—Ä —Å 5 endpoints:

#### Endpoint 1: `GET /api/v1/articles/{article_id}/prices`

–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞.

**Response:**
```json
{
  "article_id": "...",
  "article_number": "123456789",
  "price": 1799.00,
  "normal_price": 1999.00,
  "ozon_card_price": 1799.00,
  "old_price": 2499.00,
  "average_price_7days": 1950.00,
  "price_updated_at": "2025-10-21T12:00:00",
  "currency": "RUB"
}
```

#### Endpoint 2: `GET /api/v1/articles/{article_id}/price-history?days=7`

–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω –∑–∞ –ø–µ—Ä–∏–æ–¥.

**Query Parameters:**
- `days` (1-30, default: 7)

**Response:**
```json
{
  "article_number": "123456789",
  "days": 7,
  "total_records": 7,
  "history": [
    {
      "price_date": "2025-10-21T00:00:00",
      "price": 1799.00,
      "normal_price": 1999.00,
      "ozon_card_price": 1799.00,
      "old_price": 2499.00,
      "product_available": true
    }
  ]
}
```

#### Endpoint 3: `GET /api/v1/articles/{article_id}/price-average?days=7`

–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ü–µ–Ω (—Å—Ä–µ–¥–Ω—è—è, –º–∏–Ω, –º–∞–∫—Å).

**Response:**
```json
{
  "article_number": "123456789",
  "days": 7,
  "avg_price": 1950.00,
  "min_price": 1899.00,
  "max_price": 1999.00,
  "data_points": 7,
  "first_date": "2025-10-14T00:00:00",
  "last_date": "2025-10-21T00:00:00"
}
```

#### Endpoint 4: `POST /api/v1/articles/{article_id}/refresh-prices`

–û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞ (–≤—ã–ø–æ–ª–Ω–∏—Ç—å web scraping).

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –í—ã–ø–æ–ª–Ω—è–µ—Ç scraping –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞
- –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —Ç–∏–ø—ã —Ü–µ–Ω –≤ –ë–î
- –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –∑–∞ 7 –¥–Ω–µ–π
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

#### Endpoint 5: `POST /api/v1/articles/update-all-averages`

–ú–∞—Å—Å–æ–≤–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤.

**Response:**
```json
{
  "success": true,
  "updated_count": 42,
  "message": "–°—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è 42 –∞—Ä—Ç–∏–∫—É–ª–æ–≤"
}
```

#### 4.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–§–∞–π–ª:** `backend/main.py`

- ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —Ä–æ—É—Ç–µ—Ä `prices`
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `/api/v1/articles`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ–≥ "Prices üí∞" –≤ Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**–§–∞–π–ª:** `backend/routers/__init__.py`

- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –º–æ–¥—É–ª—å `prices`

#### 4.3 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ endpoint —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ç–∏–∫—É–ª–∞

**–§–∞–π–ª:** `backend/routers/articles.py`

**–ú–µ—Ç–æ–¥:** `POST /api/v1/articles`

–û–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π:
- `normal_price`
- `ozon_card_price`
- `price_updated_at`

---

### ‚úÖ Phase 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 5.1 –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

**–§–∞–π–ª:** `backend/test_price_features.py`

**–¢–µ—Å—Ç—ã:**
1. ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω —á–µ—Ä–µ–∑ OzonScraper
2. ‚úÖ SQL —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω
3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–∏—Ö —Ü–µ–Ω
4. ‚úÖ –†–∞–±–æ—Ç–∞ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**–ó–∞–ø—É—Å–∫:**
```bash
cd backend
python test_price_features.py
```

#### 5.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| –ú–∏–≥—Ä–∞—Ü–∏—è 004 | ‚úÖ | –¢–∞–±–ª–∏—Ü–∞ price_history —Å–æ–∑–¥–∞–Ω–∞ |
| –ú–∏–≥—Ä–∞—Ü–∏—è 006 | ‚úÖ | –ü–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ articles |
| SQL —Ñ—É–Ω–∫—Ü–∏–∏ | ‚úÖ | get_average_price_7days —Ä–∞–±–æ—Ç–∞–µ—Ç |
| Cron Job | ‚úÖ | price_history_collector –≥–æ—Ç–æ–≤ |
| OzonScraper | ‚úÖ | –ü–∞—Ä—Å–∏–Ω–≥ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ü–µ–Ω |
| API endpoints | ‚úÖ | 5 endpoints —Å–æ–∑–¥–∞–Ω—ã –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã |
| –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö | ‚úÖ | –í—Å–µ –º–æ–¥–µ–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã |

---

### ‚úÖ Phase 6: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### 6.1 –°–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

1. **`PRICE_FEATURES.md`** ‚≠ê - –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
   - –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ü–µ–Ω
   - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è
   - –°—Ö–µ–º–∞ –ë–î –∏ SQL —Ñ—É–Ω–∫—Ü–∏–∏
   - API endpoints —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
   - Workflow –∏ –¥–∏–∞–≥—Ä–∞–º–º—ã
   - Troubleshooting

2. **`AIL-305_IMPLEMENTATION_SUMMARY.md`** - —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç (—Å–≤–æ–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

3. **`CRON_SETUP.md`** - —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª, —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∑–∞–ø—É—Å–∫—É Cron Jobs

#### 6.2 –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- ‚úÖ `backend/cron_jobs/README.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Cron Jobs
- ‚úÖ `backend/services/ozon_scraper.py` - docstrings –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤
- ‚úÖ `backend/routers/prices.py` - docstrings –¥–ª—è –≤—Å–µ—Ö endpoints

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏ (–∏–∑ –∑–∞–¥–∞—á–∏ AIL-305)

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω Cron Job –¥–ª—è —Å–±–æ—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω (—Ä–∞–∑ –≤ 24—á) | ‚úÖ |
| –¢–∞–±–ª–∏—Ü–∞ `ozon_scraper_price_history` —Å–æ–∑–¥–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ |
| –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ (SQL AVG) | ‚úÖ |
| –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–∞—Ä—Å–∏–Ω–≥ —Ü–µ–Ω—ã –±–µ–∑ Ozon –∫–∞—Ä—Ç—ã —Å —Å–∞–π—Ç–∞ | ‚úÖ |
| –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–∞—Ä—Å–∏–Ω–≥ —Ü–µ–Ω—ã —Å Ozon –∫–∞—Ä—Ç–æ–π —Å —Å–∞–π—Ç–∞ | ‚úÖ |
| –î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î | ‚úÖ |
| –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ |
| API endpoints –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω —Ä–∞–±–æ—Ç–∞—é—Ç | ‚úÖ |
| –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | ‚úÖ |

**–í—Å–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! ‚úÖ**

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-------|----------|
| `migrations/006_add_detailed_prices_to_articles.sql` | 168 | –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è articles |
| `routers/prices.py` | 410 | API endpoints –¥–ª—è —Ü–µ–Ω |
| `test_price_features.py` | 277 | –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç |
| `docs/PRICE_FEATURES.md` | 633 | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π —Ü–µ–Ω |
| `docs/AIL-305_IMPLEMENTATION_SUMMARY.md` | 478 | –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç |

**–ò—Ç–æ–≥–æ:** ~1,966 —Å—Ç—Ä–æ–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|----------|
| `services/ozon_scraper.py` | ~180 —Å—Ç—Ä–æ–∫ | –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Ü–µ–Ω |
| `models/article.py` | +5 –ø–æ–ª–µ–π | –ù–æ–≤—ã–µ –ø–æ–ª—è —Ü–µ–Ω |
| `routers/articles.py` | +2 –ø–æ–ª—è | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ü–µ–Ω |
| `routers/__init__.py` | +1 –∏–º–ø–æ—Ä—Ç | –≠–∫—Å–ø–æ—Ä—Ç prices |
| `main.py` | +1 —Ä–æ—É—Ç–µ—Ä | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ prices |

**–ò—Ç–æ–≥–æ:** ~200 —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

1. **‚úÖ –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ** - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã —Å —Ü–µ–Ω–∞–º–∏:
   - Web scraping ‚Üí –ë–î ‚Üí –ò—Å—Ç–æ—Ä–∏—è ‚Üí –°—Ä–µ–¥–Ω–∏–µ ‚Üí API

2. **‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - Cron Job —Å–æ–±–∏—Ä–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –±–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞

3. **‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ —Å —Ç—ã—Å—è—á–∞–º–∏ –∞—Ä—Ç–∏–∫—É–ª–æ–≤:
   - Batch processing
   - Rate limiting
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

4. **‚úÖ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å**:
   - Retry –ª–æ–≥–∏–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
   - Fallback —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
   - –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases (–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ü–µ–Ω—ã —Å –∫–∞—Ä—Ç–æ–π –∏ —Ç.–¥.)

5. **‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:
   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (PRICE_FEATURES.md)
   - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ API
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - Troubleshooting

---

## üîú –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (Future work)

### –ù–µ –≤—Ö–æ–¥–∏–ª–æ –≤ scope –∑–∞–¥–∞—á–∏, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
   - –ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω (chart.js –∏–ª–∏ recharts)
   - Dashboard —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π —Ü–µ–Ω
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–Ω–∏–∂–µ–Ω–∏–∏ —Ü–µ–Ω

2. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:**
   - –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –±—É–¥—É—â–∏—Ö —Ü–µ–Ω (ML)
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏
   - –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–∫—É–ø–∫–∏

3. **–£–ª—É—á—à–µ–Ω–∏—è scraping:**
   - Proxy —Ä–æ—Ç–∞—Ü–∏—è –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
   - Playwright stealth mode
   - –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü

4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π scraping (asyncio.gather)
   - Distributed task queue (Celery)

---

## ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏:

- ‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é
- ‚úÖ Cron Job –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É (Docker –∏–ª–∏ —Å–∏—Å—Ç–µ–º–∞)
- ‚úÖ API endpoints –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

### –ß—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:**
   ```sql
   -- –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ Supabase SQL Editor
   -- 004_ozon_scraper_price_history.sql
   -- 006_add_detailed_prices_to_articles.sql
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å Cron Job:**
   ```bash
   # –ß–µ—Ä–µ–∑ Docker
   docker-compose up cron-worker
   
   # –ò–ª–∏ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π cron
   0 3 * * * python -m cron_jobs.price_history_collector
   ```

3. **–ü–æ–¥–æ–∂–¥–∞—Ç—å 7 –¥–Ω–µ–π** –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω

4. **(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä—ã** –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö OZON

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ó–∞–¥–∞—á–∞ **AIL-305** —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! 

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏ —Ç–æ–≤–∞—Ä–æ–≤ OZON:
- üí≥ –ü–∞—Ä—Å–∏–Ω–≥ —Ü–µ–Ω —Å/–±–µ–∑ Ozon Card
- üìä –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω
- üìà –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –∑–∞ 7 –¥–Ω–µ–π
- üåê REST API –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –∏—Å—Ç–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ Cron Job
- üìö –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã, –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production.

---

**Task:** AIL-305  
**Status:** ‚úÖ COMPLETED  
**Date Completed:** 2025-10-21  
**Next Steps:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å Cron Job

